# We removed points between three weeks before and three weeks after the fall and spring equinoxes
# (1 September 2022—13 October 2022 and 27 February 2023—10 April 2023),
# because similar day length around the world during this period results in high error for latitude estimates.


library(GeoLocTools)
library(GeoLight)
setupGeolocation()


ID <- "BA814"
Species <- "LusSve"

lon.calib <- -0.81
lat.calib <- 45.47

wd <- "data"

raw <- readMTlux(paste0(wd, "/RawData/", Species, "/", ID, ".lux"))
names(raw) <- c("Date", "Light")
raw$Light  <- log(raw$Light+0.0001) + abs(min(log(raw$Light+0.0001)))
head(raw)

str(raw)


threshold <- 1

col = colorRampPalette(c('black',"purple",'orange'))(50)[as.numeric(cut(raw[2000:5000,2],breaks = 50))]

par(mfrow = c(1, 1), mar = c(2, 2, 2, 2) )
with(raw[2000:5000,], plot(Date, Light, type = "o", pch=16,  col = col, cex = 0.5))
abline(h=threshold, col="orange", lty = 2, lwd = 2)


offset <- 12 # adjusts the y-axis to put night (dark shades) in the middle

lightImage( tagdata = raw,
            offset = offset,
            zlim = c(0, 20))

tsimageDeploymentLines(raw$Date, lon = lon.calib, lat = lat.calib,
                       offset = offset, lwd = 3, col = adjustcolor("orange", alpha.f = 0.5))


#
# twl <- preprocessLight(raw,
#                        threshold = threshold,
#                        offset = offset,
#                        lmax = 20,         # max. light valu
#                        gr.Device = "x11") # MacOS version (and windows)
#
# head(twl)
#
# write.csv(twl, paste0(wd, "/Results/", Species, "/", ID, "_twl.csv"), row.names = F)


#######

twl <- read.csv(paste0(wd, "/Results/", Species, "/", ID, "_twl.csv"))
twl$Twilight <- as.POSIXct(twl$Twilight, tz = "GMT") # get the Twilight times back into the POSIX. class format

offset <- 12 # adjusts the y-axis to put night (dark shades) in the middle


twl <- twilightEdit(twilights = twl,
                    offset = offset,
                    window = 4,           # two days before and two days after
                    outlier.mins = 45,    # difference in mins
                    stationary.mins = 25, # are the other surrounding twilights within 25 mins of one another
                    plot = TRUE)



lightImage( tagdata = raw,
            offset = offset,
            zlim = c(0, 4))

tsimagePoints(twl$Twilight, offset = offset, pch = 16, cex = 1.2,
              col = ifelse(twl$Deleted, "grey20", ifelse(twl$Rise, "firebrick", "cornflowerblue")))


twl <- subset(twl, !Deleted) # only rows that are not marked as deleted.


library(FLightR)

# Étape 1 — préparer gl_twl
gl_twl <- data.frame(
  tFirst  = twl$Twilight,
  tSecond = twl$Twilight + 60,
  type    = ifelse(twl$Rise, 1, 2)
)

# Étape 2 — s’assurer des bons noms de colonnes
names(raw) <- c("Date", "light")

# Étape 3 — générer et sauvegarder le fichier _twl.csv
out_file <- paste0(wd, "/Results/", Species, "/", ID, "_twl.csv")
FLightR::GeoLight2TAGS(raw = raw, gl_twl = gl_twl, threshold = 1, filename = out_file)


# Étape 4 — charger les données dans FLightR
FLightR.data <- get.tags.data(out_file)



Calibration.periods<-data.frame(
  calibration.start=as.POSIXct(c(NA)),
  calibration.stop=as.POSIXct(c('2016-07-15')),
  lon=lon.calib, lat=lat.calib)
# use c() also for the geographic coordinates,
# if you have more than one calibration location
# (e. g.,  lon=c(5.43, 6.00), lat=c(52.93,52.94))
print(Calibration.periods)


Calibration<-make.calibration(FLightR.data, Calibration.periods, model.ageing=TRUE, plot.final = T)



Grid <- make.grid(left=-10, bottom=30, right=15, top=55,
                  distance.from.land.allowed.to.use=c(-Inf, 400),
                  distance.from.land.allowed.to.stay=c(-Inf, 50))


# ~ 15 min run time
all.in <- make.prerun.object(FLightR.data, Grid, start=c(lon.calib, lat.calib),
                             Calibration=Calibration, M.mean=400)



save(all.in, file = paste0(wd, "/Results/", Species, "/", ID, "_FlightRCalib.RData"))



nParticles=1e4
Result<-run.particle.filter(all.in, threads=-1,
                            nParticles=nParticles, known.last=TRUE,
                            precision.sd=25, check.outliers=F,
                            b=1000)



save(Result, file = paste0(wd, "/Results/", Species, "/", ID, "_FLightRResult.RData"))



plot_lon_lat(Result)

Summary<-stationary.migration.summary(Result, prob.cutoff = 0.1)



# Now we want to plot the detected stationary periods on a map
Summary$Stationary.periods$stopover_duration<-as.numeric(difftime(Summary$Stationary.periods$Departure.Q.50,Summary$Stationary.periods$Arrival.Q.50, units='days'))
# Now I want to select the periods which were >=2 days and
Main_stopovers<-Summary$Stationary.periods[is.na(Summary$Stationary.periods$stopover_duration) | Summary$Stationary.periods$stopover_duration>=2,]
# delete breeding season
Main_stopovers<-Main_stopovers[-which(is.na(Main_stopovers$stopover_duration)),]

Coords2plot<-cbind(Result$Results$Quantiles$Medianlat, Result$Results$Quantiles$Medianlon)

for (i in 1:nrow(Summary$Potential_stat_periods)) {
  Coords2plot[Summary$Potential_stat_periods[i,1]:
                Summary$Potential_stat_periods[i,2],1] =
    Summary$Stationary.periods$Medianlat[i]

  Coords2plot[Summary$Potential_stat_periods[i,1]:
                Summary$Potential_stat_periods[i,2],2] =
    Summary$Stationary.periods$Medianlon[i]
}
Coords2plot<-Coords2plot[!duplicated(Coords2plot),]

#pdf('FLightR_shrike_migration_with_stopovers.pdf', width=6, height=9)
par(mar=c(0,0,0,0))
map('worldHires', ylim=c(30, 55), xlim=c(-10, 15), col=grey(0.7),
    fill=TRUE, border=grey(0.9), mar=rep(0.5, 4), myborder=0)

lines(Coords2plot[,1]~Coords2plot[,2], col='red', lwd=2)
points(Coords2plot[,1]~Coords2plot[,2], ,lwd=2, col='red', pch=19)

# Here we assign the colours to represent time of the year
Seasonal_palette<-grDevices::colorRampPalette(grDevices::hsv(1-((1:365)+(365/4))%%365/365,
                                                             s=0.8, v=0.8), space="Lab")
Seasonal_colors<-Seasonal_palette(12)

Main_stopovers$Main_month<-as.numeric(format(Main_stopovers$Arrival.Q.50+
                                               Main_stopovers$stopover_duration/2, format='%m'))

points(Main_stopovers$Medianlat~Main_stopovers$Medianlon, pch=21,
       cex=log(as.numeric(Main_stopovers$stopover_duration)),
       bg=Seasonal_colors[Main_stopovers$Main_month])

# Now, for each of these points we plot the uncertainties
# Horizontal
segments(y0=Main_stopovers$Medianlat, x0=Main_stopovers$FstQu.lon,
         x1=Main_stopovers$TrdQu.lon, lwd=2)
# Vertical
segments(x0=Main_stopovers$Medianlon, y0=Main_stopovers$FstQu.lat,
         y1=Main_stopovers$TrdQu.lat, lwd=2)

# and we also need to add breeding site here:
points(x=12.23, y=55.98, cex=6, pch=21 , bg=Seasonal_colors[6])
# dev.off()
